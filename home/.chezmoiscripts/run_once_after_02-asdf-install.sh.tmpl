{{ template "common" }}

install_asdf() {
  bot "Checking asdf..."
  echo
  if ! _exists asdf ; then
    read -p "Would you like to install asdf? [y/N]" -n 1 answer
    echo
    if [[ $answer =~ (yes|y|Y) ]] ;then
      action "Cloning git repo..."
      git clone https://github.com/asdf-vm/asdf.git ~/.asdf --branch v0.14.0
      source ~/.asdf/asdf.sh
    else
      ok "Skipping"
    fi
  else
    ok "asdf already installed"
  fi
}

configure_asdf() {
  bot "Checking asdf..."
  if _exists asdf; then
    echo "asdf detected!"
    install_asdf_tools
  else
    warn "asdf binary not detected. Skipping..."
  fi
}

install_asdf_tools() {
  echo
  read -p "Would you like to install the languages defined in .tool-versions? [y/N]" -n 1 answer
  echo
  if [[ $answer =~ (yes|y|Y) ]];then
    if cat ~/.tool-versions > /dev/null 2>&1 ;then
      while read -r line; do
        # get the first word of the line
        language=`echo $line | head -n1 | awk '{print $1;}'`
        running "$language"
        # is language already installed?
        if ! asdf where $language > /dev/null 2>&1 ;then
          # does the plugin exist in the remote repos?
          if asdf plugin list all | grep -E "^$language\s" > /dev/null 2>&1 ;then
            # is the plugin not installed already?
            if ! asdf plugin list | grep "$language" > /dev/null 2>&1 ;then
              action "asdf plugin-add $language"
              asdf plugin-add $language
            fi
            action "asdf list-all $language"
            asdf list-all $language > /dev/null
            ok
            action "asdf install $language"
            asdf install $language && ok || error "Couldn't install $language"
          else
            error "Plugin $language does not exist."
          fi
        else
          echo "$language already installed."
        fi
        ok

      done < ~/.tool-versions
    else
      error "~/.tool-versions not found. Skipping..."
    fi
  else
    ok "Skipping"
  fi
}

main() {
  install_asdf "$*"
  configure_asdf "$*"
}

main "$*"
